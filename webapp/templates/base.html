<!DOCTYPE html>
<html lang="ru">
<head>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta charset="UTF-8">
    <!-- –û—Ç–∫–ª—é—á–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ -->
    <!-- <script src="{{ url_for('static', filename='js/cache-manager.js') }}"></script> -->
    <!-- <script src="{{ url_for('static', filename='js/cached-data-loader.js') }}"></script> -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë—É–ª—å–∫ - –ü—Ä–æ–¥—É–∫—Ü–∏—è</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- –û—Ç–∫–ª—é—á–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ -->
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='css/cache-loader.css') }}"> -->
    <link rel="stylesheet" href="{{ url_for('static', filename='product-detail.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<!--
    <style>
/*
        .quantity-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 5px;
        }

        .quantity-controls .quantity-btn {
            padding: 5px 10px; /* –ù–µ–º–Ω–æ–≥–æ –æ—Ç—Å—Ç—É–ø–æ–≤ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
            cursor: pointer;
            border: 1px solid #ccc;
            background-color: #f8f8f8;
            line-height: 1.5; /* –î–ª—è –ª—É—á—à–µ–≥–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ –∫–Ω–æ–ø–∫–µ */
        }

        .quantity-controls .quantity-display {
            padding: 5px 10px; /* –û—Ç—Å—Ç—É–ø—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ */
            border-top: 1px solid #ccc;
            border-bottom: 1px solid #ccc;
            min-width: 20px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞, —á—Ç–æ–±—ã —á–∏—Å–ª–æ –Ω–µ –ø—Ä—ã–≥–∞–ª–æ */
            text-align: center;
            line-height: 1.5; /* –î–ª—è –ª—É—á—à–µ–≥–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ */
        }

        /* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ –∏ —á–∏—Å–ª–æ –≤—ã–≥–ª—è–¥–µ–ª–∏ –∫–∞–∫ –µ–¥–∏–Ω—ã–π –±–ª–æ–∫ */
        .quantity-controls .minus-btn {
            border-right: none;
            border-radius: 4px 0 0 4px;
        }

        .quantity-controls .plus-btn {
            border-left: none;
            border-radius: 0 4px 4px 0;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
        #temporary-message-container {
            position: fixed;
            bottom: 20px; /* –ò–∑–º–µ–Ω–µ–Ω–æ —Å top */
            left: 50%;    /* –î–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è */
            transform: translateX(-50%); /* –î–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è */
            z-index: 10000; /* –ü–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
            display: flex;
            flex-direction: column;
            align-items: center; /* –ß—Ç–æ–±—ã —Å–æ–æ–±—â–µ–Ω–∏—è –±—ã–ª–∏ –ø–æ —Ü–µ–Ω—Ç—Ä—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
            gap: 8px; /* –ù–µ–º–Ω–æ–≥–æ —É–º–µ–Ω—å—à–µ–Ω —Ä–∞–∑—Ä—ã–≤ */
        }

        .temporary-message {
            padding: 6px 12px; /* –£–º–µ–Ω—å—à–µ–Ω—ã –æ—Ç—Å—Ç—É–ø—ã */
            border-radius: 4px; /* –ù–µ–º–Ω–æ–≥–æ —É–º–µ–Ω—å—à–µ–Ω —Ä–∞–¥–∏—É—Å */
            font-size: 0.85em; /* –£–º–µ–Ω—å—à–µ–Ω —à—Ä–∏—Ñ—Ç */
            box-shadow: 0 1px 4px rgba(0,0,0,0.15); /* –ë–æ–ª–µ–µ –º—è–≥–∫–∞—è —Ç–µ–Ω—å */
            max-width: 300px; /* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
            text-align: center;
        }
        .temporary-message.info {
            background-color: #f0f0f0; /* –°–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π —Ñ–æ–Ω */
            color: #333; /* –¢–µ–º–Ω—ã–π —Ç–µ–∫—Å—Ç */
            border: 1px solid #e0e0e0; /* –¢–æ–Ω–∫–∞—è —Ä–∞–º–∫–∞ */
        }
        .temporary-message.error {
            background-color: #f8d7da; /* –°–≤–µ—Ç–ª–æ-–∫—Ä–∞—Å–Ω—ã–π —Ñ–æ–Ω (Bootstrap —Å—Ç–∏–ª—å) */
            color: #721c24; /* –¢–µ–º–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π —Ç–µ–∫—Å—Ç (Bootstrap —Å—Ç–∏–ª—å) */
            border: 1px solid #f5c6cb; /* –†–∞–º–∫–∞ –≤ —Ü–≤–µ—Ç (Bootstrap —Å—Ç–∏–ª—å) */
        }
        */
    </style>
-->
</head>
<body>
    <header>
        <div class="top-bar">
            {% if request.endpoint != 'view_cart' %}
            <a href="{{ url_for('categories_list') }}" class="nav-button categories-button">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</a>
            {% else %}
            <a href="{{ url_for('all_products') }}" class="nav-button categories-button">–ù–∞–∑–∞–¥ –∫ –º–µ–Ω—é</a>
            {% endif %}
            <a href="{{ url_for('all_products') }}" class="logo-link">
                <div class="logo">
                    <span class="logo-text">–ë—É–ª—å–∫ <span class="header-title-business">B2B</span></span>
                    <span class="logo-subtext">—Å–µ—Ç—å –ø–µ—Ç–µ—Ä–±—É—Ä–≥—Å–∫–∏—Ö –ø–µ–ª—å–º–µ–Ω–Ω—ã—Ö</span>
                </div>
            </a>
            {% if request.endpoint != 'view_cart' %}
            <a href="{{ url_for('view_cart') }}" class="nav-button cart-button" id="header-cart-button">
                <span id="cart-info">–ö–æ—Ä–∑–∏–Ω–∞ (<span id="cart-total-items">0</span>)</span>
            </a>
            {% else %}
            <div style="width: 120px;"></div> <!-- –ü—É—Å—Ç–æ–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –≤ —à–∞–ø–∫–µ -->
            {% endif %}
        </div>
    </header>
    
    <!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã, –∫–æ—Ç–æ—Ä–∞—è –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ -->
    {% if request.endpoint != 'view_cart' %}
    <a href="{{ url_for('view_cart') }}" class="fixed-cart-button" id="fixed-cart-button" style="display: none;">
        <span id="fixed-cart-info">–ö–æ—Ä–∑–∏–Ω–∞ (<span id="fixed-cart-total-items">0</span>)</span>
    </a>
    {% endif %}
    <main>
        {% block content %}{% endblock %}
    </main>

    {% block scripts %}{% endblock %}

    <footer>
        <p>–ö–û–ù–¢–ê–ö–¢–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø: –¢–ï–õ. +7(931) 281-12-38; –ü–û–ß–¢–ê: dl@boolk.pro</p>
        <p>boolk.ru</p>
    </footer>

<script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
    function initializeTelegramWebApp() {
        console.log('Checking for Telegram Web App...');
        if (window.Telegram && window.Telegram.WebApp) {
            const tg = window.Telegram.WebApp;
            console.log('Telegram Web App found!');
            
            // –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const initDataUnsafe = tg.initDataUnsafe || {};
            const userData = initDataUnsafe.user || {};

            console.log('Telegram User Data:', userData);

            if (userData.id) {
                console.log('User ID found, syncing with backend...');
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ –±—ç–∫–µ–Ω–¥
                fetch("{{ url_for('telegram_user_sync') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData),
                })
                .then(response => response.json())
                .then(data => {
                    console.log('User sync response:', data);
                })
                .catch(error => {
                    console.error('Error syncing user:', error);
                })
                .finally(() => {
                    // –í –ª—é–±–æ–º —Å–ª—É—á–∞–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                    initializeApp();
                });
            } else {
                console.log('No user ID found, initializing app anyway...');
                // –ï—Å–ª–∏ –Ω–µ—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≤—Å–µ —Ä–∞–≤–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                initializeApp();
            }

            // –°–æ–æ–±—â–∞–µ–º Telegram, —á—Ç–æ Web App –≥–æ—Ç–æ–≤–æ –∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—é
            tg.ready();
        } else {
            console.log('No Telegram Web App found, initializing app directly...');
            // –ï—Å–ª–∏ Telegram Web App –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞–ø—Ä—è–º—É—é
            initializeApp();
        }
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã
        const headerCartButton = document.getElementById('header-cart-button');
        const fixedCartButton = document.getElementById('fixed-cart-button');
        
        if (headerCartButton && fixedCartButton) {
            // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É
            fixedCartButton.style.display = 'none';
            fixedCartButton.style.opacity = '0';
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è/–∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è
            fixedCartButton.style.transition = 'opacity 0.3s ease';
            
            // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏
            let isButtonVisible = false;
            
            // –ü–æ—Ä–æ–≥ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞
            const scrollThreshold = 100; // –ü–∏–∫—Å–µ–ª–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–Ω–æ–ø–∫–∏
            function showButton() {
                if (!isButtonVisible) {
                    fixedCartButton.style.display = 'flex';
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è
                    setTimeout(() => {
                        fixedCartButton.style.opacity = '1';
                    }, 50);
                    isButtonVisible = true;
                }
            }
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –∫–Ω–æ–ø–∫–∏
            function hideButton() {
                if (isButtonVisible) {
                    fixedCartButton.style.opacity = '0';
                    setTimeout(() => {
                        fixedCartButton.style.display = 'none';
                    }, 300);
                    isButtonVisible = false;
                }
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
            let scrollTimer;
            window.addEventListener('scroll', function() {
                // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
                clearTimeout(scrollTimer);
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                const scrollPosition = window.scrollY;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–ª–∏ —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                if (scrollPosition > scrollThreshold) {
                    showButton();
                } else {
                    hideButton();
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —á–∞—Å—Ç—ã—Ö –≤—ã–∑–æ–≤–æ–≤
                scrollTimer = setTimeout(function() {
                    // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                    if (window.scrollY > scrollThreshold) {
                        showButton();
                    } else {
                        hideButton();
                    }
                }, 100);
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            if (window.scrollY > scrollThreshold) {
                showButton();
            }
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å
        setTimeout(initializeTelegramWebApp, 300);
    });

    // Debounce —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }
    
    // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    let cartNotificationTimestamp = 0;
    
    // --- Cart JavaScript ---
    // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É —Å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ–º –∑–∞–ø—Ä–æ—Å–æ–≤
    function addToCart(productId, quantity) {
        console.log('addToCart called with productId:', productId, 'quantity:', quantity);
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram, –µ—Å–ª–∏ –æ–Ω–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
        let userData = {};
        if (window.Telegram && window.Telegram.WebApp) {
            const tg = window.Telegram.WebApp;
            userData = tg.initDataUnsafe.user || {};
            console.log('Telegram user data:', userData);
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–¥–∏–Ω—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        fetch("{{ url_for('api_cart_unified') }}", { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                product_id: productId, 
                quantity: quantity,
                user_data: userData
            }),
        })
        .then(response => {
            console.log('Unified cart operation response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Unified cart operation response data:', data);
            if (data.status === 'success') {
                console.log('Cart operation successful, updating UI...');
                updateCartUI(data.cart); // –û–±–Ω–æ–≤–ª—è–µ—Ç –æ–±—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ—Ä–∑–∏–Ω–µ
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É
                window.showTemporaryMessage('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É', 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞, –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
                if (data.changed_item) {
                    updateProductSpecificUI(
                        data.changed_item.product_id, 
                        data.changed_item.new_quantity, 
                        data.changed_item.price_per_unit
                    );
                    
                    // –ï—Å–ª–∏ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–æ—Ä–∑–∏–Ω—ã –∏ —Ç–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω, —Å–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
                    const isCartPage = window.location.pathname.includes('/cart');
                    if (isCartPage && data.changed_item.new_quantity <= 0) {
                        // –°–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
                        const cartItem = document.getElementById(`cart-item-${data.changed_item.product_id}`);
                        if (cartItem) {
                            cartItem.style.display = 'none';
                            
                            // –°–æ–∑–¥–∞–µ–º –∏ –¥–∏—Å–ø–∞—Ç—á–∏–º —Å–æ–±—ã—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã
                            document.dispatchEvent(new Event('cart:updated'));
                        }
                    }
                } else {
                    console.warn('Backend response did not contain changed_item details for precise UI update.');
                }
            } else {
                showTemporaryMessage('–û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
        })
        .catch((error) => {
            console.error('Error in cart operation:', error);
            showTemporaryMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –∫–æ—Ä–∑–∏–Ω–æ–π.', 'error');
        });
    }
    
    // –°–æ–∑–¥–∞–µ–º –¥–µ–±–∞—É–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É –∏ –¥–µ–ª–∞–µ–º –µ–µ –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ–π
    window.debouncedAddToCart = debounce(addToCart, 300); // 300ms –∑–∞–¥–µ—Ä–∂–∫–∞
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–æ—á–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
    function setDirectQuantity(productId, newQuantity) {
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram, –µ—Å–ª–∏ –æ–Ω–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
        let userData = {};
        if (window.Telegram && window.Telegram.WebApp) {
            const tg = window.Telegram.WebApp;
            userData = tg.initDataUnsafe.user || {};
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–æ—á–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        fetch("{{ url_for('api_cart_unified') }}", { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                product_id: productId, 
                set_quantity: newQuantity, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä set_quantity –≤–º–µ—Å—Ç–æ quantity
                user_data: userData
            }),
        })
        .then(response => {
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                updateCartUI(data.cart); // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ—Ä–∑–∏–Ω–µ
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞
                window.showTemporaryMessage(`–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ ${newQuantity}`, 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞, –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
                if (data.changed_item) {
                    updateProductSpecificUI(
                        data.changed_item.product_id, 
                        data.changed_item.new_quantity, 
                        data.changed_item.price_per_unit
                    );
                    
                    // –ï—Å–ª–∏ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–æ—Ä–∑–∏–Ω—ã –∏ —Ç–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω, —Å–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
                    const isCartPage = window.location.pathname.includes('/cart');
                    if (isCartPage && data.changed_item.new_quantity <= 0) {
                        // –°–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
                        const cartItem = document.getElementById(`cart-item-${data.changed_item.product_id}`);
                        if (cartItem) {
                            cartItem.style.display = 'none';
                            
                            // –°–æ–∑–¥–∞–µ–º –∏ –¥–∏—Å–ø–∞—Ç—á–∏–º —Å–æ–±—ã—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã
                            document.dispatchEvent(new Event('cart:updated'));
                        }
                    }
                }
            } else {
                showTemporaryMessage('–û—à–∏–±–∫–∞: ' + data.message, 'error');
            }
        })
        .catch((error) => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞:', error);
            showTemporaryMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞.', 'error');
        });
    }

    function updateCartUI(cartData) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω–µ
        const cartTotalItems = document.getElementById('cart-total-items');
        if (cartTotalItems) {
            cartTotalItems.textContent = cartData.total_items;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–µ –∫–æ—Ä–∑–∏–Ω—ã
        const fixedCartTotalItems = document.getElementById('fixed-cart-total-items');
        if (fixedCartTotalItems) {
            fixedCartTotalItems.textContent = cartData.total_items;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω–µ, –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        const cartTotalAmount = document.getElementById('cart-total-amount');
        if (cartTotalAmount) {
            cartTotalAmount.textContent = Math.round(cartData.total_amount) + ' ‚ÇΩ';
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–æ—Ä–∑–∏–Ω—ã
        const isCartPage = window.location.pathname.includes('/cart');
        
        // –ï—Å–ª–∏ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–æ—Ä–∑–∏–Ω—ã –∏ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞, –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        if (isCartPage && cartData.total_items === 0) {
            checkEmptyCartAndUpdateUI();
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—É—Å—Ç–æ–π –∫–æ—Ä–∑–∏–Ω—ã –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    function checkEmptyCartAndUpdateUI() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ
        const cartItems = document.querySelectorAll('.cart-item');
        
        // –ï—Å–ª–∏ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ –∏–ª–∏ –≤—Å–µ —Ç–æ–≤–∞—Ä—ã —Å–∫—Ä—ã—Ç—ã
        let hasVisibleItems = false;
        cartItems.forEach(item => {
            if (item.style.display !== 'none') {
                hasVisibleItems = true;
            }
        });
        
        if (!hasVisibleItems) {
            // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—É—Å—Ç–æ–π –∫–æ—Ä–∑–∏–Ω–µ
            const cartItemsList = document.querySelector('.cart-items-list');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—É—Å—Ç–æ–π –∫–æ—Ä–∑–∏–Ω–µ
            let emptyCartMessage = document.querySelector('.empty-cart-message');
            
            if (!emptyCartMessage) {
                // –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—É—Å—Ç–æ–π –∫–æ—Ä–∑–∏–Ω–µ
                emptyCartMessage = document.createElement('p');
                emptyCartMessage.className = 'empty-cart-message';
                emptyCartMessage.textContent = '–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.';
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∫–æ–º —Ç–æ–≤–∞—Ä–æ–≤
                if (cartItemsList) {
                    cartItemsList.parentNode.insertBefore(emptyCartMessage, cartItemsList);
                    cartItemsList.style.display = 'none';
                }
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É –∏ –∫–Ω–æ–ø–∫–∏
            const cartTotal = document.querySelector('.cart-total');
            const cartButtons = document.querySelector('.cart-buttons-container');
            
            if (cartTotal) cartTotal.style.display = 'none';
            if (cartButtons) cartButtons.style.display = 'none';
        }
    }

    // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ–π, —á—Ç–æ–±—ã –æ–Ω–∞ –±—ã–ª–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
    window.showTemporaryMessage = function(message, type = 'info') {
        // –ó–∞–º–µ–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ –∫—ç—à–µ –Ω–∞ –±–æ–ª–µ–µ –ø–æ–ª–µ–∑–Ω—ã–µ
        if (message.includes('–ö—ç—à —Ç–æ–≤–∞—Ä–æ–≤ –æ—á–∏—â–µ–Ω')) {
            message = '–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É';
            type = 'success';
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–æ –ª–∏ –Ω–µ–¥–∞–≤–Ω–æ —Ç–∞–∫–æ–≥–æ –∂–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const now = Date.now();
            if (now - cartNotificationTimestamp < 1000) { // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É
                console.log('Skipping duplicate cart notification');
                return;
            }
            cartNotificationTimestamp = now;
        }

        const messageContainerId = 'temporary-message-container';
        let container = document.getElementById(messageContainerId);
        if (!container) {
            container = document.createElement('div');
            container.id = messageContainerId;
            document.body.appendChild(container);
        }

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ —ç–∫—Ä–∞–Ω–µ
        const maxMessages = 1; // –£–º–µ–Ω—å—à–∞–µ–º –¥–æ 1, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∑–∞–≥—Ä–æ–º–æ–∂–¥–µ–Ω–∏—è
        while (container.childElementCount >= maxMessages) {
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            container.removeChild(container.firstChild);
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–æ–µ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        let isDuplicate = false;
        Array.from(container.children).forEach(child => {
            if (child.innerText === message) {
                // –ï—Å–ª–∏ —Ç–∞–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –µ—Å—Ç—å, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ –∞–Ω–∏–º–∞—Ü–∏—é
                child.style.animation = 'none';
                setTimeout(() => {
                    child.style.animation = 'slideUp 0.3s ease-out, fadeOut 0.5s ease-in 2.5s forwards';
                }, 10);
                isDuplicate = true;
            }
        });

        // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –¥—É–±–ª–∏–∫–∞—Ç, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if (!isDuplicate) {
            const messageDiv = document.createElement('div');
            messageDiv.innerText = message;
            messageDiv.classList.add('temporary-message');

            if (type === 'success') {
                messageDiv.classList.add('success');
            } else if (type === 'error') {
                messageDiv.classList.add('error');
            } else {
                messageDiv.classList.add('info');
            }
            
            container.appendChild(messageDiv);

            // –°–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–µ–Ω–æ —á–µ—Ä–µ–∑ –∞–Ω–∏–º–∞—Ü–∏—é fadeOut
            // –ù–æ –¥–æ–±–∞–≤–∏–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
            setTimeout(() => {
                if (messageDiv && messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 2000); // –£–º–µ–Ω—å—à–∞–µ–º –≤—Ä–µ–º—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ 2 —Å–µ–∫—É–Ω–¥
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    function fetchCartState() {
        fetch("/api/cart/state") 

            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.cart) {
                    updateCartUI(data.cart);
                } else if (data.status === 'success' && !data.cart) {
                    // –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ –∏–ª–∏ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞
                    updateCartUI({ total_items: 0, total_amount: 0.0 });
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã:', error);
            });
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–∞—Ö –≤ –∫–æ—Ä–∑–∏–Ω–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
    function fetchCartItems() {
        fetch("{{ url_for('get_cart_items') }}")
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.items && data.items.length > 0) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
                    data.items.forEach(item => {
                        updateProductSpecificUI(item.product_id, item.quantity, item.price_per_unit);
                    });
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–∞—Ö –≤ –∫–æ—Ä–∑–∏–Ω–µ:', error);
            });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    function initializeApp() {
        console.log('Initializing app...');
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫—ç—à-–º–µ–Ω–µ–¥–∂–µ—Ä, –µ—Å–ª–∏ –æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω
        if (window.CacheManager) {
            CacheManager.init({
                cacheDuration: 5 * 60 * 1000, // 5 –º–∏–Ω—É—Ç
                enabled: true
            });
            console.log('Cache manager initialized');
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
        fetchCartState();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–∞—Ö –≤ –∫–æ—Ä–∑–∏–Ω–µ
        fetchCartItems();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã
        initializeCartButtons();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–Ω–æ–ø–æ–∫ –∫–æ—Ä–∑–∏–Ω—ã
    function initializeCartButtons() {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        document.addEventListener('click', function(event) {
            const target = event.target;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ü–µ–ª—å —Å—Å—ã–ª–∫–æ–π –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ –µ—ë —Ä–æ–¥–∏—Ç–µ–ª–µ–º
            if (target.classList.contains('product-name-link') || 
                (target.parentElement && target.parentElement.classList.contains('product-name-link'))) {
                // –ù–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫–∏ –ø–æ —Å—Å—ã–ª–∫–∞–º –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤
                return;
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É"
            if (target.classList.contains('js-add-to-cart')) {
                const productId = target.dataset.productId;
                debouncedAddToCart(productId, 1);
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã –¥–ª—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫—ç—à–∞
                document.dispatchEvent(new Event('cart:updated'));
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            else if (target.classList.contains('js-increase-quantity')) {
                const productId = target.dataset.productId;
                debouncedAddToCart(productId, 1);
                document.dispatchEvent(new Event('cart:updated'));
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ —É–º–µ–Ω—å—à–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            else if (target.classList.contains('js-decrease-quantity')) {
                const productId = target.dataset.productId;
                debouncedAddToCart(productId, -1);
                document.dispatchEvent(new Event('cart:updated'));
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –Ω–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞
            else if (target.classList.contains('js-editable-quantity')) {
                const productId = target.dataset.productId;
                const currentQuantity = parseInt(target.textContent, 10);
                
                // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
                const input = document.createElement('input');
                input.type = 'number';
                input.min = '1';
                input.value = currentQuantity;
                input.className = 'quantity-input';
                input.style.width = '40px';
                input.style.textAlign = 'center';
                input.style.border = 'none';
                input.style.background = 'transparent';
                input.style.fontSize = '14px';
                
                // –ó–∞–º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
                target.textContent = '';
                target.appendChild(input);
                input.focus();
                input.select();
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ—Ç–µ—Ä–∏ —Ñ–æ–∫—É—Å–∞
                const handleBlur = () => {
                    const newQuantity = parseInt(input.value, 10) || 1;
                    if (newQuantity !== currentQuantity) {
                        setDirectQuantity(productId, newQuantity);
                    } else {
                        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç, –µ—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
                        target.textContent = currentQuantity;
                    }
                    input.removeEventListener('blur', handleBlur);
                    input.removeEventListener('keydown', handleKeyDown);
                };
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–ª–∞–≤–∏—à–∏ Enter
                const handleKeyDown = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        input.blur();
                    }
                };
                
                input.addEventListener('blur', handleBlur);
                input.addEventListener('keydown', handleKeyDown);
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—Ä—É–≥–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        });
    }

    // –í—ã–∑—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞, 
    // Initialize after dynamic content loading if necessary
    document.addEventListener('DOMContentLoaded', initializeApp);

    function updateProductSpecificUI(productId, newQuantityInCart, pricePerUnit) { // Added pricePerUnit for cart page
        console.log('updateProductSpecificUI called with productId:', productId, 'newQuantityInCart:', newQuantityInCart, 'pricePerUnit:', pricePerUnit);
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–Ω–æ–≤—ã–π –¥–∏–∑–∞–π–Ω)
        const addButton = document.querySelector(`.product-image-cart-button[data-product-id='${productId}']`);
        const quantityControls = document.querySelector(`.product-image-quantity-controls[data-product-id='${productId}']`);
        const quantityDisplay = document.querySelector(`.js-product-quantity-display[data-product-id='${productId}']`);
        
        console.log('Found elements:', {
            addButton: addButton ? 'yes' : 'no',
            quantityControls: quantityControls ? 'yes' : 'no',
            quantityDisplay: quantityDisplay ? 'yes' : 'no'
        });

        // –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–æ—Ä–∑–∏–Ω—ã
        const quantityDisplayCartPage = document.getElementById(`quantity-${productId}`);
        const subtotalDisplayCartPage = document.getElementById(`subtotal-${productId}`);
        const cartItemDiv = document.getElementById(`cart-item-${productId}`);
        const cartTotalAmountElement = document.getElementById('cart-total-amount');

        // –û–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
        if (addButton && quantityControls) {
            console.log('Updating product UI elements...');
            if (newQuantityInCart > 0) {
                console.log('Setting quantity > 0 UI state');
                addButton.style.display = 'none';
                quantityControls.style.display = 'flex'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º flex –¥–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞, –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                if (quantityDisplay) {
                    quantityDisplay.textContent = newQuantityInCart;
                }
            } else {
                addButton.style.display = 'block';
                quantityControls.style.display = 'none';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞, –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                if (quantityDisplay) {
                    quantityDisplay.textContent = '0';
                }
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–æ—Ä–∑–∏–Ω—ã, –µ—Å–ª–∏ –æ–Ω–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
        if (quantityDisplayCartPage) {
            quantityDisplayCartPage.textContent = newQuantityInCart;
        }

        if (subtotalDisplayCartPage && pricePerUnit !== undefined) {
            const newSubtotal = newQuantityInCart * pricePerUnit;
            subtotalDisplayCartPage.textContent = `${Math.floor(newSubtotal)} ‚ÇΩ`;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
        if (cartItemDiv) {
            if (newQuantityInCart <= 0) {
                cartItemDiv.style.display = 'none';
            } else {
                cartItemDiv.style.display = 'flex';
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É –≤ –∫–æ—Ä–∑–∏–Ω–µ, –µ—Å–ª–∏ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–æ—Ä–∑–∏–Ω—ã
        if (cartTotalAmountElement && window.location.href.includes('cart')) {
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â—É—é —Å—É–º–º—É –∫–æ—Ä–∑–∏–Ω—ã
            let newTotal = 0;
            document.querySelectorAll('.cart-item-subtotal').forEach(subtotal => {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "123.45 ‚ÇΩ" -> 123.45)
                const value = parseFloat(subtotal.textContent.replace(/[^0-9.]/g, ''));
                if (!isNaN(value)) {
                    newTotal += value;
                }
            });
            cartTotalAmountElement.textContent = `${newTotal.toFixed(2)} ‚ÇΩ`;
        }
    }

    // –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º addToCart, —á—Ç–æ–±—ã –æ–Ω–∞ —Ç–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–ª–∞ UI –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
    // –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è addToCart –æ—Å—Ç–∞–µ—Ç—Å—è, –Ω–æ –≤ –µ–µ .then(data => { ... }) –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ updateProductSpecificUI
    // –î–ª—è —ç—Ç–æ–≥–æ –≤ –æ—Ç–≤–µ—Ç–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ /api/cart/add —Ö–æ—Ä–æ—à–æ –±—ã –∏–º–µ—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞.
    // –ü–æ–∫–∞ —á—Ç–æ –Ω–∞—à –±—ç–∫–µ–Ω–¥ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç newQuantityInCart –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞, 
    // –∞ —Ç–æ–ª—å–∫–æ –æ–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–æ—Ä–∑–∏–Ω–µ. –≠—Ç–æ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ –±—ç–∫–µ–Ω–¥–µ.
    // –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –º—ã –º–æ–∂–µ–º –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –Ω–∞–π—Ç–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑ –æ–±—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω–µ, –µ—Å–ª–∏ –æ–Ω –±—É–¥–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è.
    // –ò–ª–∏, –µ—Å–ª–∏ –±—ç–∫–µ–Ω–¥ —É–¥–∞–ª—è–µ—Ç —Ç–æ–≤–∞—Ä –ø—Ä–∏ quantity <=0, —Ç–æ total_items –≤ –æ—Ç–≤–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—Å—è.

    // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º success —á–∞—Å—Ç—å –≤ addToCart
    // –≠—Ç–æ –Ω–µ —Å–∞–º—ã–π —á–∏—Å—Ç—ã–π —Å–ø–æ—Å–æ–±, –ª—É—á—à–µ –±—ã –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å productId –≤ updateCartUI –∏ –¥–µ–ª–∞—Ç—å –≤—Å–µ —Ç–∞–º
    // –∏–ª–∏ –ø–æ–ª—É—á–∞—Ç—å –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.

    // –î–∞–≤–∞–π—Ç–µ –ø–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º –∫–∞–∫ –µ—Å—Ç—å, –∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ addToCart, –µ—Å–ª–∏ total_items –∏–∑–º–µ–Ω–∏–ª—Å—è,
    // –º–æ–∂–Ω–æ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç—å, —á—Ç–æ —Ç–æ–≤–∞—Ä –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω/—É–¥–∞–ª–µ–Ω/–∏–∑–º–µ–Ω–µ–Ω.
    // –ù–æ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∏—Å–ª–∞ `product-X-quantity` –Ω—É–∂–µ–Ω –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º.
    // –ú—ã –æ–±–Ω–æ–≤–∏–º —ç—Ç–æ –ø–æ—Å–ª–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏ –±—ç–∫–µ–Ω–¥–∞.

</script>

<!-- –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞ -->
<div id="cache-control-panel" class="cache-control-panel">
    <button id="clear-cache-btn" class="cache-control-btn" title="–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –∏ –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞">
        <span class="cache-icon">üîÑ</span>
        <span class="cache-text">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</span>
    </button>
</div>

<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—ç—à–µ–º */
    .cache-control-panel {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
    }
    
    .cache-control-btn {
        display: flex;
        align-items: center;
        background-color: rgba(255, 255, 255, 0.9);
        border: 1px solid #ddd;
        border-radius: 30px;
        padding: 8px 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        color: #333;
    }
    
    .cache-control-btn:hover {
        background-color: #FBB03B;
        color: white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    }
    
    .cache-icon {
        margin-right: 8px;
        font-size: 16px;
    }
    
    @media (max-width: 768px) {
        .cache-control-panel {
            bottom: 15px;
            right: 15px;
        }
        
        .cache-text {
            display: none;
        }
        
        .cache-control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            justify-content: center;
            padding: 0;
        }
        
        .cache-icon {
            margin-right: 0;
        }
    }
</style>

<script>
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞
    document.addEventListener('DOMContentLoaded', function() {
        const clearCacheBtn = document.getElementById('clear-cache-btn');
        if (clearCacheBtn) {
            clearCacheBtn.addEventListener('click', function() {
                // –û—á–∏—â–∞–µ–º –≤–µ—Å—å –∫—ç—à
                if (window.CacheManager) {
                    CacheManager.clearAllCache();
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showTemporaryMessage('–ú–µ–Ω–µ–¥–∂–µ—Ä –∫—ç—à–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
                }
            });
        }
    });
</script>
</body>
</html>